<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Admin</title>
    <link rel="stylesheet" href="style.css">
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
</head>
<body>
    <header>
        <nav>
            <ul>
                <li><a href="index.html">Home</a></li>
                <li><a href="register.html">Register & Pay</a></li>
                <li><a href="admin.html">Admin</a></li>
            </ul>
        </nav>
    </header>
    <main>
        <h1>Admin Page</h1>
        <canvas id="usageChart" width="400" height="200"></canvas>
    </main>
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/9.19.1/firebase-app.js";
        import { getDatabase, ref, onValue, query, orderByChild, startAt } from "https://www.gstatic.com/firebasejs/9.19.1/firebase-database.js";

        const firebaseConfig = {
            apiKey: "AIzaSyAqx_A1kf7D0W4M9wN69Zt3iRUgn59DNQU",
            authDomain: "sps-7122.firebaseapp.com",
            databaseURL: "https://sps-7122-default-rtdb.asia-southeast1.firebasedatabase.app",
            projectId: "sps-7122",
            storageBucket: "sps-7122.appspot.com",
            messagingSenderId: "973386811954",
            appId: "1:973386811954:web:7b3c6df23612225a630a2b",
            measurementId: "G-KG1LK1H4TW"
        };

        const app = initializeApp(firebaseConfig);
        const db = getDatabase(app);

        // Fetch past 6 hours of data
        const sixHoursAgo = new Date().getTime() - (6 * 60 * 60 * 1000);
        const slotRef = query(ref(db, 'slots'), orderByChild('timestamp'), startAt(sixHoursAgo));

        const labels = [];
        const usageData = Array(6).fill(0).map(() => Array(6).fill(0)); // 6 slots, 6 hours

        onValue(slotRef, (snapshot) => {
            const data = snapshot.val();
            if (data) {
                Object.values(data).forEach(entry => {
                    const entryTime = new Date(entry.timestamp).getHours();
                    const currentHour = new Date().getHours();
                    const hourIndex = (currentHour - entryTime + 6) % 6;

                    for (let i = 1; i <= 6; i++) {
                        if (entry[`slot${i}`] === 1) {
                            usageData[hourIndex][i - 1]++;
                        }
                    }
                });

                const formattedUsageData = usageData.map(slot => slot.reduce((a, b) => a + b, 0));

                for (let i = 0; i < 6; i++) {
                    const hourLabel = new Date().getHours() - i;
                    labels.unshift(`${(hourLabel + 24) % 24}:00`);
                }

                const ctx = document.getElementById('usageChart').getContext('2d');
                new Chart(ctx, {
                    type: 'line',
                    data: {
                        labels: labels,
                        datasets: [{
                            label: 'Slot Usage (past 6 hours)',
                            data: formattedUsageData,
                            borderColor: 'rgba(75, 192, 192, 1)',
                            borderWidth: 1,
                            fill: false,
                        }]
                    },
                    options: {
                        scales: {
                            y: {
                                beginAtZero: true,
                                max: 6
                            }
                        }
                    }
                });
            }
        });
    </script>
</body>
</html>
